name: "Test"
description: "Run unit tests"
inputs:
  disk_cache:
    description: 'Build system cache key'
    required: false
    default: test-${{ github.ref }}-${{ runner.os }}
runs:
  using: "composite"
  steps:
    - run: echo "BAZEL_CONFIG=linux" >> $GITHUB_ENV
      shell: bash
      if: runner.os == 'Linux'
    - run: echo "BAZEL_CONFIG=windows" >> $GITHUB_ENV
      shell: bash
      if: runner.os == 'Windows'
    - run: echo "BAZEL_CONFIG=macos" >> $GITHUB_ENV
      shell: bash
      if: runner.os == 'macOS'
    - run: bazel test -c dbg //src/cc/tests:* --test_output=all --test_timeout 30 --config=${{ env.BAZEL_CONFIG }}
      shell: bash
      name: run cpp tests
    - run: bazel test -c dbg //src/python/deepgnn/...:* --jobs 1 --test_output=all --test_timeout 600 --config=${{ env.BAZEL_CONFIG }}
      shell: bash
      name: run python tests
    - run: |
        bazel run -c dbg //examples/pytorch:gat_pyg --config=${{ env.BAZEL_CONFIG }}
        bazel run -c dbg //examples/pytorch:gat_ray --config=${{ env.BAZEL_CONFIG }}
        bazel run -c dbg //examples/pytorch:sage --config=${{ env.BAZEL_CONFIG }}
        bazel run -c dbg //examples/pytorch:tgn --config=${{ env.BAZEL_CONFIG }}
        bazel run -c dbg //examples/pytorch/hetgnn:main --config=${{ env.BAZEL_CONFIG }}
      shell: bash
      name: run python examples
      if: runner.os == 'Linux'
    - run: |
        bazel test -c dbg //docs:* --test_output=all --config=linux
        bazel run -c dbg //docs:make_docs --config=linux
      shell: bash
      name: run doctest and build documentation
      if: runner.os == 'Linux'
    - run: bazel build -c dbg src/cc/lib/benchmark:* --config=${{ env.BAZEL_CONFIG }}
      shell: bash
      name: build benchmarks
      if: runner.os == 'Linux'
